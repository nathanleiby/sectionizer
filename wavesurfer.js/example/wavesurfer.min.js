"use strict";var WaveSurfer={defaultParams:{waveColor:"#999",progressColor:"#333",cursorColor:"#ddd",cursorWidth:1,markerWidth:1,skipLength:2,minPxPerSec:1,pixelRatio:1,fillParent:!0,scrollParent:!1,AudioContext:null,container:null,renderer:"Canvas"},init:function(t){this.params=WaveSurfer.util.extend({},this.defaultParams,t),this.drawer=Object.create(WaveSurfer.Drawer[this.params.renderer]),this.drawer.init(this.params),this.drawer.on("redraw",this.drawBuffer.bind(this)),this.markers={},this.createBackend(),this.bindClick(),this.savedVolume=-1,this.isMuted=!1},createBackend:function(){var t=this;this.backend=Object.create(WaveSurfer.WebAudio),this.backend.on("audioprocess",function(){t.fireEvent("progress")}),this.on("progress",function(){t.drawer.progress(t.backend.getPlayedPercents())}),this.backend.init(this.params)},playAt:function(t){this.backend.play(this.backend.getDuration()*t)},play:function(){this.backend.play()},pause:function(){this.backend.pause()},playPause:function(){this.backend.isPaused()?this.play():this.pause()},skipBackward:function(t){this.skip(t||-this.params.skipLength)},skipForward:function(t){this.skip(t||this.params.skipLength)},skip:function(t){var e=this.timings(t),i=e[0]/e[1];this.seekTo(i)},seekTo:function(t){var e=this.backend.isPaused();this.playAt(t),e&&(this.pause(),this.fireEvent("progress")),this.fireEvent("seek",t)},stop:function(){this.playAt(0),this.pause(),this.drawer.progress(0)},setVolume:function(t){this.backend.setVolume(t)},toggleMute:function(){this.isMuted?(this.backend.setVolume(this.savedVolume),this.savedVolume=-1,this.isMuted=!1):(this.savedVolume=this.backend.getVolume(),this.backend.setVolume(0),this.isMuted=!0)},mark:function(t){var e=this,i=WaveSurfer.util.extend({id:WaveSurfer.util.getId(),position:this.backend.getCurrentTime(),width:this.params.markerWidth},t),r=Object.create(WaveSurfer.Mark);return r.on("update",function(){var t=e.backend.getDuration()||1;null==r.position&&(r.position=r.percentage*t),r.percentage=r.position/t,e.drawer.addMark(r),e.markers[r.id]=r}),r.on("remove",function(){e.drawer.removeMark(r),delete e.markers[r.id]}),r.update(i)},clearMarks:function(){Object.keys(this.markers).forEach(function(t){this.markers[t].remove()},this)},timings:function(t){var e=this.backend.getCurrentTime()||0,i=this.backend.getDuration()||1;return e=Math.max(0,Math.min(i,e+(t||0))),[e,i]},drawBuffer:function(){var t=this.backend.getDuration()||1;Object.keys(this.markers).forEach(function(e){var i=this.markers[e];i.update({percentage:i.position/t})},this);var e=this.drawer.getPixels(t),i=this.backend.getPeaks(e),r=this.backend.getMaxPeak();this.drawer.drawPeaks(i,r)},load:function(t){var e=this,i=new XMLHttpRequest;i.open("GET",t,!0),i.send(),i.responseType="arraybuffer",i.addEventListener("progress",function(t){var i;i=t.lengthComputable?t.loaded/t.total:t.loaded/(t.loaded+1e6),e.fireEvent("loading",i)}),i.addEventListener("load",function(t){e.fireEvent("loading",1),e.backend.loadBuffer(t.target.response,function(){e.fireEvent("loading",100),e.drawBuffer(),e.fireEvent("ready")})})},bindDragNDrop:function(t){var e=this,i=new FileReader;i.addEventListener("load",function(t){e.backend.loadBuffer(t.target.result,function(){e.drawBuffer(),e.fireEvent("ready")})},!1),(t||document).addEventListener("drop",function(t){t.preventDefault();var e=t.dataTransfer.files[0];e&&i.readAsArrayBuffer(e)},!1)},bindClick:function(){var t=this;this.drawer.on("click",function(e){t.seekTo(e)})},bindMarks:function(){var t=this,e=this.markers;this.on("progress",function(){Object.keys(e).forEach(function(i){var r=e[i],s=r.position.toPrecision(3),a=t.backend.getCurrentTime().toPrecision(3);s==a&&(t.fireEvent("mark",r),r.fireEvent("reached"))})})},empty:function(){this.stop(),this.backend.loadEmpty(),this.drawer.drawPeaks({length:this.drawer.getWidth()},0)}};WaveSurfer.Mark={id:null,position:0,percentage:0,width:1,color:"",getTitle:function(){var t=new Date(1e3*this.position);return t.getMinutes()+":"+t.getSeconds()},update:function(t){return Object.keys(t).forEach(function(e){e in this&&(this[e]=t[e])},this),null==t.position&&null!=t.percentage&&(this.position=null),this.fireEvent("update"),this},remove:function(){this.fireEvent("remove")}},WaveSurfer.Observer={on:function(t,e){this.handlers||(this.handlers={});var i=this.handlers[t];i||(i=this.handlers[t]=[]),i.push(e)},un:function(t,e){if(this.handlers){var i=this.handlers[t];if(i)if(e)for(var r=i.length-1;r>=0;r--)i[r]==e&&i.splice(r,1);else i.length=0}},fireEvent:function(t){if(this.handlers){var e=this.handlers[t],i=Array.prototype.slice.call(arguments,1);if(e)for(var r=0,s=e.length;s>r;r+=1)e[r].apply(null,i)}}},WaveSurfer.util={extend:function(t){var e=Array.prototype.slice.call(arguments,1);return e.forEach(function(e){null!=e&&Object.keys(e).forEach(function(i){t[i]=e[i]})}),t},getId:function(){return"wavesurfer_"+Math.random().toString(32).substring(2)}},WaveSurfer.util.extend(WaveSurfer,WaveSurfer.Observer),WaveSurfer.util.extend(WaveSurfer.Mark,WaveSurfer.Observer),WaveSurfer.WebAudio={init:function(t){this.ac=t.AudioContext||new(window.AudioContext||window.webkitAudioContext),this.createScriptNode(),this.createVolumeNode()},getFilter:function(){return this.filterNode||this.gainNode},setFilter:function(t){this.filterNode=t,this.filterNode.connect(this.gainNode),this.source&&!this.isPaused()&&(this.pause(),this.play())},createScriptNode:function(){var t=this;this.scriptNode=this.ac.createScriptProcessor?this.ac.createScriptProcessor(256):this.ac.createJavaScriptNode(256),this.scriptNode.connect(this.ac.destination),this.scriptNode.onaudioprocess=function(){t.source&&!t.isPaused()&&(t.getCurrentTime()>=t.scheduledPause?t.pause():t.fireEvent("audioprocess"))}},createVolumeNode:function(){this.gainNode=this.ac.createGain?this.ac.createGain():this.ac.createGainNode(),this.gainNode.connect(this.ac.destination)},setVolume:function(t){this.gainNode.gain.value=t},getVolume:function(){return this.gainNode.gain.value},refreshBufferSource:function(){this.source&&this.source.disconnect(),this.source=this.ac.createBufferSource(),this.buffer&&(this.source.buffer=this.buffer),this.source.connect(this.getFilter()),this.fireEvent("reconnect")},setBuffer:function(t){this.lastPause=0,this.lastStart=0,this.startTime=0,this.paused=!0,this.buffer=t},loadBuffer:function(t,e,i){var r=this;this.source&&this.pause(),this.ac.decodeAudioData(t,function(t){r.setBuffer(t),e&&e(t)},function(){console.error("Error decoding audio buffer"),i&&i()})},loadEmpty:function(){this.pause(),this.setBuffer(0)},isPaused:function(){return this.paused},getDuration:function(){return this.buffer.duration},play:function(t,e){this.refreshBufferSource(),null==t&&(t=this.getCurrentTime()),null==e&&(e=this.getDuration()),t>e&&(t=0),this.lastStart=t,this.startTime=this.ac.currentTime,this.paused=!1,this.scheduledPause=e,this.source.start?this.source.start(0,t,e-t):this.source.noteGrainOn(0,t,e-t)},pause:function(){this.lastPause=this.lastStart+(this.ac.currentTime-this.startTime),this.paused=!0,this.source.stop?this.source.stop(0):this.source.noteOff(0),this.source.disconnect(),this.source=null},getPeaks:function(t,e){e=e||128;for(var i=this.buffer,r=i.length/t,s=new Float32Array(t),a=0;i.numberOfChannels>a;a++)for(var n=i.getChannelData(a),h=0;t>h;h++){for(var o=-1/0,c=~~(h*r),u=(h+1)*r,d=c;u>d;d+=e){var l=n[d];l>o?o=l:-l>o&&(o=-l)}a>0?s[h]+=o:s[h]=o}return s},getMaxPeak:function(){return 1*this.buffer.numberOfChannels},getPlayedPercents:function(){var t=this.getDuration();return t>0?this.getCurrentTime()/t:0},getCurrentTime:function(){return this.isPaused()?this.lastPause:this.lastStart+(this.ac.currentTime-this.startTime)}},WaveSurfer.util.extend(WaveSurfer.WebAudio,WaveSurfer.Observer),WaveSurfer.Drawer={init:function(t){if(this.params=t,this.pixelRatio=this.params.pixelRatio,this.container="string"==typeof this.params.container?document.querySelector(this.params.container):this.params.container,this.width=this.container.clientWidth*this.pixelRatio,this.height=this.container.clientHeight*this.pixelRatio,this.lastPos=0,this.createElements(),this.bindClick(),this.params.fillParent){var e=this;window.addEventListener("resize",function(){e.container.scrollWidth!=e.scrollWidth&&e.fireEvent("redraw")})}},drawPeaks:function(t,e){this.setWidth(t.length),this.drawWave(t,e)},style:function(t,e){Object.keys(e).forEach(function(i){t.style[i]=e[i]})},bindClick:function(){var t=this;this.container.addEventListener("click",function(e){var i=e.offsetX;null==i&&(i=e.layerX);var r=i/t.scrollWidth;t.fireEvent("click",r)},!1)},addScroll:function(){this.style(this.container,{overflowX:"scroll",overflowY:"hidden"})},recenter:function(t){var e=this.scrollWidth*t;this.recenterOnPosition(e,!0)},recenterOnPosition:function(t,e){var i=this.container.scrollLeft,r=this.container.clientWidth/2,s=t-r,a=s-i;if(!e&&a>=-r&&r>a){var n=5;a=Math.max(-n,Math.min(n,a)),s=i+a}a>0&&(this.container.scrollLeft=s)},getPixels:function(t){var e=Math.ceil(t*this.params.minPxPerSec);return this.params.fillParent&&(e=Math.max(this.container.clientWidth,e)),e*this.pixelRatio},getWidth:function(){return this.width},setWidth:function(t){this.width=t,this.scrollWidth=Math.round(this.width/this.pixelRatio),this.params.scrollParent&&this.addScroll(),this.updateWidth()},progress:function(t){var e=1/this.pixelRatio,i=Math.round(t*this.width*this.pixelRatio)*e;(this.lastPos>i||i-this.lastPos>=e)&&(this.lastPos=i,this.params.scrollParent&&this.recenterOnPosition(~~(this.scrollWidth*t)),this.updateProgress(t))},createElements:function(){},updateWidth:function(){},drawWave:function(){},updateProgress:function(){},addMark:function(){},removeMark:function(){}},WaveSurfer.util.extend(WaveSurfer.Drawer,WaveSurfer.Observer),WaveSurfer.Drawer.Canvas=Object.create(WaveSurfer.Drawer),WaveSurfer.util.extend(WaveSurfer.Drawer.Canvas,{createElements:function(){var t=document.createElement("canvas");this.style(t,{position:"absolute",zIndex:1});var e=t.getContext("2d"),i=document.createElement("wave");this.style(i,{position:"absolute",zIndex:2,overflow:"hidden",width:"0",borderRight:[this.params.cursorWidth+"px","solid",this.params.cursorColor].join(" ")});var r=document.createElement("canvas"),s=r.getContext("2d");i.appendChild(r);var a=document.createElement("canvas");this.style(a,{position:"absolute",zIndex:3});var n=a.getContext("2d"),h=document.createElement("wave");this.style(h,{position:"relative"}),h.appendChild(t),h.appendChild(i),h.appendChild(a),this.container.appendChild(h),this.canvases=[t,r,a],this.waveCc=e,this.progressCc=s,this.progressWave=i,this.marksCc=n,this.marks={}},updateWidth:function(){this.canvases.forEach(function(t){t.width=this.width,t.height=this.height,this.params.fillParent&&!this.params.scrollParent?this.style(t,{width:this.container.clientWidth+"px",height:this.container.clientHeight+"px"}):this.style(t,{width:Math.round(this.width/this.pixelRatio)+"px",height:Math.round(this.height/this.pixelRatio)+"px"})},this)},drawWave:function(t,e){for(var i=0;this.width>i;i++){var r=e>0?Math.round(t[i]*(this.height/e)):1,s=Math.round((this.height-r)/2);this.waveCc.fillStyle=this.params.waveColor,this.waveCc.fillRect(i,s,1,r),this.progressCc.fillStyle=this.params.progressColor,this.progressCc.fillRect(i,s,1,r)}},updateProgress:function(t){var e=Math.round(this.width*t)/this.pixelRatio;this.progressWave.style.width=e+"px"},addMark:function(t){var e=t.id in this.marks;this.marks[t.id]=t,e?this.redrawMarks():this.drawMark(t)},removeMark:function(t){delete this.marks[t.id],this.redrawMarks()},drawMark:function(t){this.marksCc.fillStyle=t.color;var e=Math.round(t.percentage*this.width-t.width/2);this.marksCc.fillRect(e,0,t.width,this.height)},redrawMarks:function(){this.marksCc.clearRect(0,0,this.width,this.height),Object.keys(this.marks).forEach(function(t){this.drawMark(this.marks[t])},this)}}),WaveSurfer.Drawer.SVG=Object.create(WaveSurfer.Drawer),WaveSurfer.util.extend(WaveSurfer.Drawer.SVG,{attr:function(t,e){Object.keys(e).forEach(function(i){t.setAttribute(i,e[i])})},node:function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg",t);return e&&this.attr(i,e),i},createElements:function(){var t=this.node("svg",{viewBox:[0,0,this.width,this.height].join(" ")}),e=this.node("defs"),i=WaveSurfer.util.getId(),r=this.node("path",{id:i});e.appendChild(r);var s=WaveSurfer.util.getId(),a=this.node("clipPath",{id:s}),n=this.node("rect",{width:0,height:this.height});a.appendChild(n),e.appendChild(a);var h=this.node("use",{stroke:this.params.waveColor,"class":"wavesurfer-wave"});h.href.baseVal="#"+i;var o=this.node("use",{stroke:this.params.progressColor,"clip-path":"url(#"+s+")","class":"wavesurfer-progress"});o.href.baseVal="#"+i,this.cursorWidth=this.params.cursorWidth*this.pixelRatio;var c=this.node("rect",{width:this.cursorWidth,height:this.height,fill:this.params.cursorColor,"class":"wavesurfer-cursor"});[e,h,o,c].forEach(function(e){t.appendChild(e)}),this.container.appendChild(t),this.svg=t,this.wavePath=r,this.progressPath=n,this.cursor=c},updateWidth:function(){this.attr(this.svg,{viewBox:[0,0,this.width,this.height].join(" ")}),this.params.scrollParent&&this.attr(this.svg,{width:this.scrollWidth,height:"100%"})},drawWave:function(t,e){var i=this.height,r=[];if(0==e)r.push("M",0,Math.round(i/2),"l",this.width,0);else for(var s=i/e,a=0;this.width>a;a++){var n=Math.round(t[a]*s),h=Math.round((i-n)/2);r.push("M",a,h,"l",0,n)}this.wavePath.setAttribute("d",r.join(" "))},updateProgress:function(){this.progressPath.setAttribute("width",this.lastPos),this.cursor.setAttribute("x",Math.min(this.lastPos-~~(this.params.cursorWidth/2),this.width-this.params.cursorWidth))},addMark:function(t){var e=document.getElementById(t.id);if(e)var i=e.querySelector("title");else e=this.node("rect"),e.setAttribute("id",t.id),this.svg.appendChild(e),i=this.node("title"),e.appendChild(i);this.attr(e,{fill:t.color,width:t.width,height:this.height,x:Math.round(t.percentage*this.width)}),i.textContent=t.getTitle()},removeMark:function(t){var e=document.getElementById(t.id);e&&this.svg.removeChild(e)}});